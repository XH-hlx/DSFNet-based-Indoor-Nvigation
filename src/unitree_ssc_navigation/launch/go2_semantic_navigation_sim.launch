<launch>
  <!-- ===================================================================== -->
  <!-- Unitree Go2 Semantic Navigation Simulation (Gazebo) -->
  <!-- Integrates: DSFNet SSC + Ego-Planner + Semantic Differentiated Costs -->
  <!-- ===================================================================== -->

  <!-- ============================================ -->
  <!-- Arguments -->
  <!-- ============================================ -->

  <!-- Robot configuration -->
  <arg name="robot_name" default="go2"/>
  <arg name="world_name" default="small_house"/>  <!-- Options: indoor_scene, stairs, empty -->

  <!-- Robot initial position (Gazebo spawn location) -->
  <arg name="spawn_x" default="-2.0"/>  <!-- X position (meters) -->
  <arg name="spawn_y" default="-2.0"/>  <!-- Y position (meters) -->
  <arg name="spawn_z" default="0.6"/>   <!-- Z position (meters, 0.6 for standing) -->
  <arg name="spawn_yaw" default="0.0"/> <!-- Yaw orientation (radians, 0=facing +X) -->

  <!-- DSFNet model -->
  <arg name="dsfnet_model_path" default="$(env HOME)/ros1_ws/DSFNet/models/best_model.pth"/>
  <arg name="use_semantic_cost" default="true"/>
  <arg name="lambda_semantic" default="5.0"/>

  <!-- Map configuration -->
  <arg name="map_size_x" default="40.0"/>
  <arg name="map_size_y" default="40.0"/>
  <arg name="map_size_z" default="3.0"/>

  <!-- Camera configuration -->
  <arg name="camera_enabled" default="true"/>
  <arg name="depth_camera" default="true"/>

  <!-- Visualization -->
  <arg name="rviz" default="true"/>
  <arg name="rqt" default="false"/>

  <!-- ============================================ -->
  <!-- 1. Gazebo Simulation with Go2 -->
  <!-- ============================================ -->

  <!-- Start Gazebo empty world -->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="world_name" value="$(find unitree_gazebo)/worlds/$(arg world_name).world"/>
    <arg name="paused" value="false"/>
    <arg name="use_sim_time" value="true"/>
    <arg name="gui" value="true"/>
    <arg name="headless" value="false"/>
    <arg name="debug" value="false"/>
  </include>

  <!-- Load Go2 URDF to parameter server -->
  <param name="robot_description"
         command="$(find xacro)/xacro --inorder '$(find go2_description)/xacro/robot.xacro' DEBUG:=false"/>

  <!-- Spawn Go2 in Gazebo with custom initial position -->
  <node pkg="gazebo_ros" type="spawn_model" name="spawn_go2"
        args="-urdf -model $(arg robot_name)_gazebo -param robot_description
              -x $(arg spawn_x) -y $(arg spawn_y) -z $(arg spawn_z) -Y $(arg spawn_yaw)
              -unpause"
        output="screen" respawn="false" />

  <!-- Load joint controller configurations -->
  <rosparam file="$(find go2_description)/config/robot_control.yaml" command="load"/>

  <!-- Load the controllers -->
  <node pkg="controller_manager" type="spawner" name="controller_spawner"
        respawn="false" output="screen" ns="/$(arg robot_name)_gazebo"
        args="joint_state_controller
              FL_hip_controller FL_thigh_controller FL_calf_controller
              FR_hip_controller FR_thigh_controller FR_calf_controller
              RL_hip_controller RL_thigh_controller RL_calf_controller
              RR_hip_controller RR_thigh_controller RR_calf_controller" />

  <!-- Robot state publisher for TF -->
  <node pkg="robot_state_publisher" type="robot_state_publisher"
        name="robot_state_publisher" respawn="false" output="screen">
    <remap from="/joint_states" to="/$(arg robot_name)_gazebo/joint_states"/>
  </node>

  <!-- Load unitree controller parameters -->
  <include file="$(find unitree_controller)/launch/set_ctrl.launch">
    <arg name="rname" value="$(arg robot_name)"/>
  </include>

  <!-- TF for Camera (RealSense is already in URDF at front_camera link) -->
  <group if="$(arg camera_enabled)">
    <!-- TF: real_sense (from URDF) → camera_link (for compatibility) -->
    <node pkg="tf" type="static_transform_publisher" name="camera_link_tf"
          args="0 0 0 0 0 0 real_sense camera_link 50" />

    <!-- TF: camera_link → camera_color_optical_frame (ROS standard) -->
    <node pkg="tf" type="static_transform_publisher" name="camera_optical_tf"
          args="0 0 0 -1.57079632679 0 -1.57079632679 camera_link camera_color_optical_frame 50" />
  </group>

  <!-- ============================================ -->
  <!-- 2. Sensor Simulation (RGB-D Camera) -->
  <!-- ============================================ -->

  <!-- NOTE: RealSense相机已在go2_description/xacro/gazebo.xacro中定义 -->
  <!-- 话题重映射: /real_sense/* → /camera/* -->

  <group if="$(arg depth_camera)">
    <!-- 重映射RGB图像 -->
    <node pkg="topic_tools" type="relay" name="rgb_relay"
          args="/real_sense/rgb/image_raw /camera/color/image_raw" />

    <!-- 重映射深度图像 -->
    <node pkg="topic_tools" type="relay" name="depth_relay"
          args="/real_sense/depth/image_raw /camera/depth/image_raw" />

    <!-- 重映射点云 -->
    <node pkg="topic_tools" type="relay" name="points_relay"
          args="/real_sense/depth/points /camera/depth/points" />

    <!-- 重映射相机信息 -->
    <node pkg="topic_tools" type="relay" name="rgb_info_relay"
          args="/real_sense/rgb/camera_info /camera/color/camera_info" />

    <node pkg="topic_tools" type="relay" name="depth_info_relay"
          args="/real_sense/depth/camera_info /camera/depth/camera_info" />
  </group>

  <!-- ============================================ -->
  <!-- 3. Odometry and TF -->
  <!-- ============================================ -->

  <!-- Publish Gazebo odometry to standard topic -->
  <node pkg="unitree_ssc_navigation" type="unitree_odom_bridge.py" name="unitree_odom_bridge" output="screen">
    <param name="odom_input_topic" value="/$(arg robot_name)_gazebo/odom"/>
    <param name="odom_output_topic" value="/visual_slam/odom"/>
    <param name="pose_output_topic" value="/robot_pose"/>
    <param name="camera_frame" value="camera_color_optical_frame"/>
    <param name="base_frame" value="base"/>
    <param name="world_frame" value="world"/>
  </node>

  <!-- ============================================ -->
  <!-- 4. DSFNet Semantic Scene Completion -->
  <!-- ============================================ -->

  <node pkg="unitree_ssc_navigation" type="dsfnet_inference_node.py"
        name="dsfnet_inference_node" output="screen" required="false">

    <!-- Model path -->
    <param name="model_path" value="$(arg dsfnet_model_path)"/>
    <param name="dsfnet_path" value="$(env HOME)/ros1_ws/DSFNet"/>

    <!-- Camera parameters (RealSense D435 defaults) -->
    <param name="fx" value="387.229248046875"/>
    <param name="fy" value="387.229248046875"/>
    <param name="cx" value="321.04638671875"/>
    <param name="cy" value="243.44969177246094"/>
    <param name="img_width" value="640"/>
    <param name="img_height" value="480"/>

    <!-- SSC parameters -->
    <param name="num_classes" value="12"/>
    <param name="voxel_size" value="[240, 144, 240]"/>
    <param name="voxel_unit" value="0.02"/>

    <!-- Semantic costs (12 classes) -->
    <rosparam param="semantic_costs">[0.1, 1.0, 0.3, 1.0, 0.9, 0.7, 0.8, 0.8, 0.7, 0.6, 0.75, 0.65]</rosparam>

    <!-- Topic remapping -->
    <remap from="/camera/color/image_raw" to="/camera/color/image_raw"/>
    <remap from="/camera/depth/image_raw" to="/camera/depth/image_raw"/>
  </node>

  <!-- ============================================ -->
  <!-- 5. Ego-Planner with Semantic Integration -->
  <!-- ============================================ -->

  <include file="$(find ego_planner)/launch/advanced_param.xml">
    <!-- Map size -->
    <arg name="map_size_x_" value="$(arg map_size_x)"/>
    <arg name="map_size_y_" value="$(arg map_size_y)"/>
    <arg name="map_size_z_" value="$(arg map_size_z)"/>

    <!-- Topics -->
    <arg name="odometry_topic" value="/visual_slam/odom"/>
    <arg name="goal_topic" value="/way_point"/>
    <arg name="camera_pose_topic" value="/camera_pose"/>
    <arg name="depth_topic" value="/camera/depth/image_raw"/>
    <arg name="cloud_topic" value="/camera/depth/points"/>

    <!-- Camera intrinsics -->
    <arg name="cx" value="321.04638671875"/>
    <arg name="cy" value="243.44969177246094"/>
    <arg name="fx" value="387.229248046875"/>
    <arg name="fy" value="387.229248046875"/>

    <!-- Robot motion limits (quadruped) -->
    <arg name="max_vel" value="1.0"/>
    <arg name="max_acc" value="2.0"/>

    <!-- Planning horizon -->
    <arg name="planning_horizon" value="7.5"/>

    <!-- Use 2D Nav Goal -->
    <arg name="flight_type" value="1"/>

    <!-- Waypoint configuration (required but not used when flight_type=1) -->
    <arg name="point_num" value="2"/>
    <arg name="point0_x" value="0.0"/>
    <arg name="point0_y" value="0.0"/>
    <arg name="point0_z" value="0.0"/>
    <arg name="point1_x" value="1.0"/>
    <arg name="point1_y" value="0.0"/>
    <arg name="point1_z" value="0.0"/>
    <arg name="point2_x" value="2.0"/>
    <arg name="point2_y" value="0.0"/>
    <arg name="point2_z" value="0.0"/>

    <!-- Semantic parameters are already set in advanced_param.xml -->
    <!-- use_semantic_cost = true, lambda_semantic = 5.0 (lines 128, 127) -->
  </include>

  <!-- ============================================ -->
  <!-- 6. Trajectory Server -->
  <!-- ============================================ -->

  <node pkg="ego_planner" name="traj_server" type="traj_server" output="screen">
    <remap from="/position_cmd" to="/planning/pos_cmd"/>
    <remap from="/odom_world" to="/visual_slam/odom"/>
    <param name="traj_server/time_forward" value="1.0" type="double"/>
  </node>

  <!-- ============================================ -->
  <!-- 7. Waypoint Generator -->
  <!-- ============================================ -->

  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
    <remap from="~odom" to="/visual_slam/odom"/>
    <remap from="~goal" to="/move_base_simple/goal"/>
    <remap from="~traj_start_trigger" to="/traj_start_trigger"/>
    <param name="waypoint_type" value="manual-lonely-waypoint"/>
  </node>

  <!-- ============================================ -->
  <!-- 8. Go2 Velocity Controller -->
  <!-- ============================================ -->

  <!-- Convert position commands to velocity commands for Go2 -->
  <node pkg="unitree_ssc_navigation" type="cmd_converter.py" name="cmd_converter" output="screen">
    <remap from="/planning/pos_cmd" to="/planning/pos_cmd"/>
    <remap from="/cmd_vel" to="/$(arg robot_name)_gazebo/cmd_vel"/>
    <param name="max_linear_vel" value="0.8"/>
    <param name="max_angular_vel" value="1.0"/>
  </node>

  <!-- ============================================ -->
  <!-- 9. Visualization -->
  <!-- ============================================ -->

  <!-- RViz -->
  <node if="$(arg rviz)" type="rviz" name="rviz" pkg="rviz"
        args="-d $(find unitree_ssc_navigation)/config/go2_semantic_nav.rviz"/>

  <!-- RQT (optional) -->
  <node if="$(arg rqt)" type="rqt_image_view" name="rqt_image_view" pkg="rqt_image_view"/>

  <!-- ============================================ -->
  <!-- 10. Monitoring and Logging -->
  <!-- ============================================ -->

  <!-- Topic monitor -->
  <node pkg="rostopic" type="rostopic" name="topic_monitor"
        args="hz /ssc_inference_node/semantic_cloud_xyz" output="screen"/>

</launch>
